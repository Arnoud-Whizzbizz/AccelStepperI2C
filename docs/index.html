<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AccelStepperI2C: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AccelStepperI2C
   &#160;<span id="projectnumber">v 0.1</span>
   </div>
   <div id="projectbrief">I2C wrapper (and a bit more) for the AccelStepper Arduino library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">AccelStepperI2C Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Warning: Pre-alpha! Not for production, only for feedback. Expect things to break, until stated otherwise.</p>
<h2><a class="anchor" id="autotoc_md0"></a>
AccelStepperI2C</h2>
<p>This is an I2C wrapper for Mike McCauley's <a href="https://www.airspayce.com/mikem/arduino/AccelStepper/index.html">AccelStepper library</a> with additional support for two end stops per stepper. It consists of the <a class="el" href="class_accel_stepper_i2_c.html">AccelStepperI2C</a> Arduino-based firmware for one or more I2C-slaves, and a corresponding Arduino library for the I2C-master. Think of it as a more accessible and more flexible replacement for dedicated I2C stepper motor controller ICs like AMIS-30622, PCA9629 or TMC223.</p>
<p><a href="https://github.com/ftjuh/AccelStepperI2C">Download AccelStepperI2C on github.</a></p>
<p><a href="https://ftjuh.github.io/AccelStepperI2C/">AccelStepperI2C library documentation</a></p>
<h3>How does it work?</h3>
<ul>
<li>One or more Arduino-likes, acting as <b>I2C-slaves</b>, run up to eight stepper motors each. The slaves run the <a class="el" href="class_accel_stepper_i2_c.html">AccelStepperI2C</a> firmware (<a class="el" href="firmware_8ino.html">firmware.ino</a>), which exposes the AccelStepper functionality via I2C. Steppers are driven by any method supported by AccelStepper except AccelStepper::FUNCTION, e.g. AccelStepper::DRIVER with StepStick compatible A4988, DRV8825 or TMC2100 stepper drivers. An obvious example is the Arduino UNO with a Protoneer CNC shield (recent <a href="https://www.elecrow.com/arduino-cnc-shield-v3-51-grbl-v0-9-compatible-uses-pololu-drivers.html">V3.51</a> or <a href="https://forum.protoneer.co.nz/viewforum.php?f=17">V3.00 clone</a>).</li>
<li>Another device, acting as <b>I2C-master</b>, controls the slave(s) via I2C with the help of the <a class="el" href="class_accel_stepper_i2_c.html">AccelStepperI2C</a> library. <a href="https://ftjuh.github.io/AccelStepperI2C/">Its interface</a> is largely identical to the original AccelStepper library.</li>
<li>Refer to the <a class="el" href="class_accel_stepper_i2_c.html">AccelStepperI2C</a> library's example folder to see how it works in detail.</li>
</ul>
<h3>Differences from AccelStepper</h3>
<ul>
<li>With the exception of two blocking functions (see below), AccelStepper needs the client to constantly 'poll' each stepper by invoking one of the run() commands (run(), runSpeed(), or runSpeedToPosition()) at a frequency which mustn't be lower than the stepping frequency. Over I2C, this would clutter the bus, put limits on stepper speeds, and be unstable if there are other I2C devices on the bus, particularly with multiple steppers and microstepping.</li>
<li>To solve this problem, the <a class="el" href="class_accel_stepper_i2_c.html">AccelStepperI2C</a> firmware implements a <b>state machine</b> for each connected stepper which makes the slave do the polling locally on its own.</li>
<li>All the master has to do is making the appropriate settings, e.g. setting a target with <a class="el" href="class_accel_stepper_i2_c.html#a06ee86271f675746386c4cb86b6c6182">AccelStepperI2C::moveTo()</a> or <a class="el" href="class_accel_stepper_i2_c.html#af9c59ca7c83e9e2452cdc6b3a3b50ed9">AccelStepperI2C::move()</a>, or choosing a speed with <a class="el" href="class_accel_stepper_i2_c.html#a2a8c92150ae055c7ff696ff98ddb7a38">AccelStepperI2C::setSpeed()</a> and then start the slave's state machine with one of<ul>
<li><a class="el" href="class_accel_stepper_i2_c.html#a934c71dc0f3b534bc859f40e785066b6" title="Will poll run(), i.e. run to the target with acceleration and stop the state machine upon reaching it...">AccelStepperI2C::runState()</a>: will poll run(), i.e. run to the target with acceleration, and stop the state machine upon reaching it</li>
<li><a class="el" href="class_accel_stepper_i2_c.html#a60f56e376242af7fe69fda51c6758ec7" title="Will poll runSpeed(), i.e. run at constant speed until told otherwise (see AccelStepperI2C::stopState...">AccelStepperI2C::runSpeedState()</a>: will poll runSpeed(), i.e. run at constant speed until told otherwise (see <a class="el" href="class_accel_stepper_i2_c.html#a509c7691efe52e80615e937e693bdbc1" title="Will stop any of the above states, i.e. stop polling. It does nothing else, so the master is solely i...">AccelStepperI2C::stopState()</a>), or</li>
<li><a class="el" href="class_accel_stepper_i2_c.html#a935522089c48b23c0e9f17b242d7d94f" title="Will poll runSpeedToPosition(), i.e. run at constant speed until target has been reached.">AccelStepperI2C::runSpeedToPositionState()</a>: will poll runSpeedToPosition(), i.e. run at constant speed until target has been reached.</li>
</ul>
</li>
<li><a class="el" href="class_accel_stepper_i2_c.html#a509c7691efe52e80615e937e693bdbc1" title="Will stop any of the above states, i.e. stop polling. It does nothing else, so the master is solely i...">AccelStepperI2C::stopState()</a> will stop any of the above states, i.e. stop polling. It does nothing else, so the master is solely in command of target, speed, and other settings.</li>
<li>Up to two <b>end stop switches</b> can be defined for each stepper. If enabled and the stepper runs into one of them, it will make the state machine stop just like <a class="el" href="class_accel_stepper_i2_c.html#a509c7691efe52e80615e937e693bdbc1" title="Will stop any of the above states, i.e. stop polling. It does nothing else, so the master is solely i...">AccelStepperI2C::stopState()</a>. Of course, this is most useful in combination with ::runSpeedState() for homing tasks at startup.</li>
</ul>
<h3>Restrictions</h3>
<ul>
<li>The original run(), runSpeed(), or runSpeedToPosition() are implemented, but I discourage using them directly. Particularly in high load situations with multiple steppers, microstepping, and other important I2C traffic, it's silly to trigger each stepper step over I2C. Use the state machine instead. If you feel you must use them, take it slowly and consider increasing I2C bus frequency.</li>
<li>Each library function call, its parameters, and return value has to be transmitted back and forth via I2C. This makes things slower, less precise, and prone to errors. To be safe from errors, you'll need to do some extra checking (see Error handling).</li>
<li>The two blocking functions, runToPosition() and <a class="el" href="_accel_stepper_i2_c_8h.html#ab6da5e42caa09167ae7c403ab66d53b8">runToNewPositionCmd()</a>, are not implemented at the moment. I never saw their purpose, anyway, as their behavior can easily implemented with the existing functionality. Also, naturally, you cannot declare your own stepping functions with the <a href="https://www.airspayce.com/mikem/arduino/AccelStepper/classAccelStepper.html#afa3061ce813303a8f2fa206ee8d012bd">constructor [2/2] variant</a>.</li>
<li>There is no interrupt mechanism at the moment which tells the master that a state machine job has finished or an endstop has been triggered. So the master still needs to poll the slave with one of <a class="el" href="class_accel_stepper_i2_c.html#a26e27bf5d72113dc43694c87ed4a75f4">AccelStepperI2C::distanceToGo()</a>, <a class="el" href="class_accel_stepper_i2_c.html#ac3a25dd2091e8b7a2aaa415150957b7e">AccelStepperI2C::currentPosition</a>, <a class="el" href="class_accel_stepper_i2_c.html#a5d61e5c0ac971764de463e1d958a517d">AccelStepperI2C::isRunning()</a>, or <a class="el" href="class_accel_stepper_i2_c.html#af27f8157184e75d824faa9634113c67c" title="Read current state of endstops.">AccelStepperI2C::endstops()</a> but can do so at a much more reasonable frequency.</li>
<li>No serialization protocol is used at the moment, so the implementation is machine dependent in regard to the endians and sizes of data types. Arduinos Uno/Nano and ESP8266 have been tested and work well together, as should any other Arduino supporting platform.</li>
<li><strike>Currently, there is no error checking of the master-slave communication, which uses a very basic (i.e. non existing) protocol. The master will have to deal with any transmission errors should they occur.</strike></li>
</ul>
<h3>Error handling</h3>
<p>If I2C transmission problems occur, any call to the library could fail and, possibly worse, every return value could be corrupted. Uncontrolled or unexpected stepper movements could lead to serious problems. That's why each command and response is sent with a CRC8 checksum. To find out if a master's command or a slave's response was <b>transmitted correctly</b>, the master can check <a class="el" href="class_accel_stepper_i2_c.html#a2c4d58dc9b219725a3d40c8756e5302e" title="True if previous function call was successfully transferred to slave.">AccelStepperI2C::sentOK</a> after each function call and <a class="el" href="class_accel_stepper_i2_c.html#a0c74bcb33dca28cd2e23a54a7da395ea" title="True if return value from previous function call was received successfully.">AccelStepperI2C::resultOK</a> after receiving data back from the slave device.</p>
<ul>
<li>If <a class="el" href="class_accel_stepper_i2_c.html#a2c4d58dc9b219725a3d40c8756e5302e" title="True if previous function call was successfully transferred to slave.">AccelStepperI2C::sentOK</a> is false, the function call was not properly transmitted.</li>
<li>If <a class="el" href="class_accel_stepper_i2_c.html#a0c74bcb33dca28cd2e23a54a7da395ea" title="True if return value from previous function call was received successfully.">AccelStepperI2C::resultOK</a> is false, the data returned from a function call is invalid.</li>
</ul>
<h3>Usage</h3>
<ol type="1">
<li>Install the libraries <a class="el" href="class_accel_stepper_i2_c.html">AccelStepperI2C</a>, <a class="el" href="class_simple_buffer.html">SimpleBuffer</a>, and of course the original AccelStepper to the Arduino environment.</li>
<li>Upload <a class="el" href="firmware_8ino.html">firmware.ino</a> to one Arduino (slave). Connect steppers and stepper drivers or use a dedicated hardware, e.g. Arduino UNO with CNC V3.00 shield.</li>
<li>Upload example sketch or your own sketch which uses the <a class="el" href="class_accel_stepper_i2_c.html">AccelStepperI2C</a> library to another Arduino-like (master).</li>
<li>Connect the I2C bus of both devices (usually A4&lt;-&gt;A4, A5&lt;-&gt;A5, GND&lt;-&gt;GND). Don't fortget two I2C pullups and, if needed, level-shifters. Also connect +5V&lt;-&gt;+5V to power one board from the other, if needed.</li>
<li>Now (not earlier) provide external power to the steppers and power to the Arduinos.</li>
</ol>
<p>Have a look at the examples for usage of the library. A couple of important things:</p>
<ul>
<li>The <a class="el" href="class_accel_stepper_i2_c.html">AccelStepperI2C</a> constructor needs the Wire library to be already initialized. So don't invoke the constructor when declaring an object, use <b>new</b> during <a class="el" href="firmware_8ino.html#a4fc01d736fe50cf5b977f755b675f11d" title="setup system">setup()</a>.</li>
<li></li>
</ul>
<h3>Documentation</h3>
<p><a href="https://ftjuh.github.io/AccelStepperI2C/">Find the AccelStepperI2C library documentation here</a>. It only deals with differences from running the AccelStepper library locally. If not stated otherwise, expect <a class="el" href="class_accel_stepper_i2_c.html">functions and parameters</a> to work as in the original, keeping the above differences and restrictions in mind.</p>
<h3>Author</h3>
<p>This is my first "serious" piece of software published on github. Although I've some background in programming, mostly in the Wirth-tradition languages, I'm far from being a competent or even avid c++ programmer. At the same time I have a tendency to over-engineer (not a good combination), so be warned and use this at your own risk. My current main interest is in 3D printing, you can find me on <a href="https://www.prusaprinters.org/social/202816-juh/about">prusaprinters</a>, <a href="https://www.thingiverse.com/juh/designs">thingiverse</a>, and <a href="https://www.youmagine.com/juh3d/designs">youmagine</a>. This library was developed as part of my <a href="https://www.prusaprinters.org/prints/115049-stepfish-fischertechnik-i2c-stepper-motor-controll">StepFish project</a> (<a href="https://forum.ftcommunity.de/viewtopic.php?t=5341">also here</a>).</p>
<p>Contact me at <a href="#" onclick="location.href='mai'+'lto:'+'juh'+'@p'+'ost'+'eo'+'.or'+'g'; return false;">juh@p<span style="display: none;">.nosp@m.</span>oste<span style="display: none;">.nosp@m.</span>o.org</a>.</p>
<p>Jan (juh)</p>
<h3>Copyright</h3>
<p>This software is Copyright (C) 2022 juh (<a href="#" onclick="location.href='mai'+'lto:'+'juh'+'@p'+'ost'+'eo'+'.or'+'g'; return false;">juh@p<span style="display: none;">.nosp@m.</span>oste<span style="display: none;">.nosp@m.</span>o.org</a>)</p>
<h3>License</h3>
<p><a class="el" href="class_accel_stepper_i2_c.html">AccelStepperI2C</a> is distributed under the GNU GENERAL PUBLIC LICENSE Version 2.</p>
<h3>History</h3>
<p>v0.1 Initial release </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
